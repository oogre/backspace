<script type="text/javascript">
	<% 
		var backspace = "";
		
		_.each(user.backspace, function(origine){ 
			_.each(origine.content, function(content, key){
				backspace = content + " " + backspace;
			});
		});
		var date = new Date(user.createdAt).toGMTString();
		var updateDate = new Date(user.updatedAt).toGMTString(); 
	%>

	var populateLastBackspace = function(data){
		if(data){
			$(".lastbackspace .book").text(data + " " + $(".lastbackspace .book").text());
		}
	}

	window.addEventListener("load", function subscribeAndListen(){
		// When the document loads, send a request to users.testSocket
		// The controller code will subscribe you to all of the 'users' model instances (records)
		io.socket.get('/backspace/subscribe/<%= user.id %>');

		// Listen for the event called 'user'
		io.socket.on('backspace', function(obj){
			 if (obj.verb == 'updated') {
                if(obj.data.backspcaced){
					populateLastBackspace(obj.data.backspcaced);
				}
				if(obj.data.volume){
					$(".backspace_length").text(obj.data.volume);
				}
			}
		});

		$("#backspace-option-form").on("submit", function(event){
			var button = $(this).find("button[type='submit']");
			var icon = button.find(".fa");
			button.removeClass("btn-primary").addClass("btn-info");
			icon.removeClass("fa-download").addClass("fa-circle-o-notch").addClass("fa-spin");
			
			var request = {};
			for(var i = 0 ; i < event.target.length ; i++){
				var name = event.target[i].name;
				if(name != "submit"){
					if($(event.target[i]).attr('type') == "checkbox"){
						request[name] = event.target[i].checked
					}	
					else if(name == "captureBlacklist"){
						var value = $(event.target[i]).val();
						request[name] = _.compact(value.split(",").map(function(u){
							return (u.split(/\:\/\//)[1]||u).split(/\//)[0].trim().replace(/www\./, "") ;
						})).join(", ");
						$(event.target[i]).val(request[name]);
					}
					else{
						request[name] = $(event.target[i]).val();
					}
				}
			}

			$.post(event.target.action, request)
			.done(function(){
				icon.removeClass("fa-circle-o-notch").removeClass("fa-spin").addClass("fa-check-circle");
				button.removeClass("btn-info").addClass("btn-success");
			})
			.fail(function(){
				icon.removeClass("fa-circle-o-notch").removeClass("fa-spin").addClass("fa-times-circle");
				button.removeClass("btn-info").addClass("btn-danger");
			});
			return false;
		});
	}, false);

</script>

</script>
<div class="container">
	<% 
		if(flash && flash.err){
			var errorName = flash.err.error;
			var errorData = flash.err.data || false;
		%>
			<div class="row">
				<div class="col-sm-offset-4 col-sm-4">
					<div class="alert alert-danger">
						<div class="row">
							<div class="col-sm-2">
								<i class="fa fa-exclamation-triangle fa-3x pull-left"></i>
							</div>
							<div class="col-sm-10">
								 <%= __(errorName) %>
							</div>
						</div>
					</div>
				</div>
			</div>
		<% 	
		}

		if(flash && flash.ok){
			var messageName = flash.ok.message;
			var messageData = flash.ok.data || false;
		%>
			<div class="row">
				<div class="col-sm-offset-4 col-sm-4">
					<div class="alert alert-success">
						<div class="row">
							<div class="col-sm-2">
								<i class="fa fa-flag fa-3x pull-left"></i>
							</div>
							<div class="col-sm-10">
								 <%= __(messageName) %>
							</div>
						</div>
					</div>
				</div>
			</div>

		<% 
		}
		
		if(!user.volume){ %>
			<div class="row">
				<div class="col-sm-offset-4 col-sm-4">
					<div class="alert alert-info">
						<div class="row">
							<div class="col-sm-2">
								<i class="fa fa-info-circle fa-3x pull-left"></i>
							</div>
							<div class="col-sm-10">
								 <%= __("user_show_stay_connected") %>
							</div>
						</div>
					</div>
				</div>
			</div>
		<% } %>

	<div class="row">
		<div class="col-sm-12">
			<h1><%= user.email %></h1>
			<hr/>
			<form action="/<%= req.session.locale %>/user/update/<%= user.id %>" method="POST" class="form-signin" id="backspace-option-form">
				<h4 class="form-backspace-option-heading"><%= __("backspace_option_form_title") %></h4>
				
				<div class="form-group">
					<label><%= __("backspace_option_form_capture")%>&nbsp;:</label>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="true" name="captureEmail" value="true" <% if(user.captureEmail){%>checked="checked"<% } %> ><%= __("backspace_option_form_captureEmail")%>
						</label>
					</div>
					<div class="checkbox">
						<label>
							<input type="checkbox" value="true" name="capturePassword" value="true" <% if(user.capturePassword){%>checked="checked"<% } %>><%= __("backspace_option_form_capturePassword")%>
						</label>
					</div>
				</div>
				<div class="form-group">
					<label for="blacklisted"><%= __("backspace_option_form_blacklist")%>&nbsp;:<small> (<%= __("backspace_option_form_rules") %>)</small></label>
					<textarea id="blacklisted" class="form-control" name="captureBlacklist" placeholder="<%= __("backspace_option_form_exemple") %>&nbsp;:&nbsp;google.com, facebook.com"><%= user.captureBlacklist || "" %></textarea>
				</div>
				<div class="form-group">
					<button type="submit" class="btn btn-md btn-primary" name="submit" >
						<i class="fa fa-2x pull-right"></i><span class="line-height-small">save</span>
					</button>
				</div>
				<input type="hidden" name="_csrf" value="<%= _csrf %>" />
			</form>
			<hr/>

			<table class="table">
				<tr>
					<th>email</th>
					<th><%= __('user_show_since') %></th>
					<th><%= __('user_show_bcksp_length') %></th>
				</tr>
				<tr data-id="<%= user.id %>" data-model="user">
					<td><%= user.email %></td>
					<td><%= date %></td>
					<td><span class="backspace_length"><%= user.volume || "-" %></span> <%= __('user_show_bcksp_unity') %></td>
				</tr>
			</table>
		</div>
	</div>
	<div class="row">
		<div class="lastbackspace highlight">
			<h4><%= __('user_show_backspace') %> : <small><%= __('live') %></small></h4>
			<div class="book"><%= backspace %></div>
		</div>
	</div>
</div>