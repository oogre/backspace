<script type="text/javascript">
	window.addEventListener("load", function subscribeAndListen(){
        // When the document loads, send a request to users.testSocket
        // The controller code will subscribe you to all of the 'users' model instances (records)
        io.socket.get('/user/subscribe/');

        // Listen for the event called 'user'
        io.socket.on('user',function(obj){
        	console.log(obj);
            if (obj.verb == 'updated') {
                if(true === obj.data.online){
                	$("[data-id='"+obj.id+"'] .onlineoffline").removeClass("fa-minus-circle").addClass("fa-check-circle");
                }else if(false === obj.data.online){
                	$("[data-id='"+obj.id+"'] .onlineoffline").removeClass("fa-check-circle").addClass("fa-minus-circle");
                }
            }
            else if(obj.verb == "created"){
				$("tr:last").after(JST["assets/templates/insertUser.ejs"]({
					user: obj.data,
					csrf: window.bcksp.csrf || ""
				}));
				$('tr:last .destroyForm').submit(destroyForm);
			}else if(obj.verb == "destroyed"){
				$("tr[data-id='"+obj.id+"']").remove();
			}
		});

        var destroyForm = function(event){
        	$.ajax({
				url : event.target.action,
				method : event.target.method,
				data : {
					_method : event.target._method.value,
					_csrf : event.target._csrf.value
				}
			});
			return false;
        };
        
		$('.destroyForm').submit(destroyForm);
		
	}, false);  	
</script>


<div class="container">
	<h3>Users</h3>
	<table class="table">
		<tr>
			<th></th>
			<th>ID</th>
			<th>email</th>
			<th>admin</th>
			<th></th>
			<th></th>
		</tr>
		<% _.each(users, function(user){ %>
		<tr data-id="<%= user.id %>" data-model="user">
			<td><i class="onlineoffline fa <% if(user.online) { %>fa-check-circle<% } else {%>fa-minus-circle<%}%>"></i></td>
			<td><%= user.id %></td>
			<td><%= user.email %></td>
			<% if(user.admin) { %>
				<td><i class="fa fa-star"></i></td>
			<% } else { %>
				<td><i class="fa fa-star-o"></i></td>
			<% } %>

			<td><a href="/user/show/<%= user.id %>" class="btn btn-sm btn-primary">Show</a></td>
			<td><a href="/user/edit/<%= user.id %>" class="btn btn-sm btn-warning">Edit</a></td>
			<td><form class="destroyForm" action="/user/destroy/<%= user.id %>"  method="POST" >
				<input type="hidden" name="_method" value="delete" />
				<input type="hidden" name="_csrf" value="<%= _csrf %>" />
				<input type="submit" class="btn btn-sm btn-danger" value="Delete" />
			</form></td>
		</tr>
		<% }) %>
	</table>
</div>